/*
    browser.js - simulates web browser like environment
*/

util_log("Preparing sandbox to emulate Browser environment (default = IE11).");

// Globals used for MalwareJail
_browser_documents = [];
_setInterval_calls = [];
_setTimeout_calls = [];

// jQuery

// This method checks if an AJAX web request was used for getting a resource, and if so, will run the
// given function if it exists. It will also simulate the server response based on the URL
function run_data_function(url, data) {
    if (data !== undefined && data.constructor.name === "Function") {
        var function_name = data.prototype.name;
        if (function_name === undefined) {
            // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions#the_function_expression
            function_name = "anonymous";
        }
        util_log("Running function " + function_name + "()");
        if (is_domain_geo(url)) {
            data(domain_geo_response);
        } else {
            data();
        }
    }
}

// https://api.jquery.com/category/deferred-object/
Deferred = _proxy(function () {
    this._id = _object_id++;
    this._name = "Deferred[" + this._id + "]";
    util_log("new " + this._name + "()");

    this.fail = function (fn) {
        util_log(this._name + ".fail(" + _truncateOutput(fn) + ")");
        fn(window);
    }
});
Deferred.toString = Deferred.toJSON = () => {
    return "Deferred"
}

// https://api.jquery.com/jQuery.get/#jqxhr-object
jqXHR = _proxy(function () {

    let ret = new XMLHttpRequest();
    this.id = ret.id;
    this._name = "jqXHR[" + this.id + "]";
    util_log("new " + this._name);

    function run_function_and_return_deferred(fn) {
        if (fn.constructor.name === "Function") {
            var function_name = fn.prototype.name;
            if (function_name === undefined) {
                // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions#the_function_expression
                function_name = "anonymous";
            }
            util_log("Running function " + function_name + "()");
            // window == data
            fn(window);
            return new Deferred();
        }
    }

    ret.done = function (fn) {
        util_log(this._name + ".done(" + _truncateOutput(fn) + ")");
        return run_function_and_return_deferred(fn);
    }

    ret.fail = function (fn) {
        util_log(this._name + ".fail(" + _truncateOutput(fn) + ")");
        return run_function_and_return_deferred(fn);
    }

    ret.always = function (fn) {
        util_log(this._name + ".always(" + _truncateOutput(fn) + ")");
        return run_function_and_return_deferred(fn);
    }

    ret.then = function (fn) {
        util_log(this._name + ".then(" + _truncateOutput(fn) + ")");
        return run_function_and_return_deferred(fn);
    }

    // The following are deprecated callback methods
    ret.success = function (fn) {
        util_log(this._name + ".success(" + _truncateOutput(fn) + ")");
        return run_function_and_return_deferred(fn);
    }

    ret.error = function (fn) {
        util_log(this._name + ".error(" + _truncateOutput(fn) + ")");
        return run_function_and_return_deferred(fn);
    }

    ret.complete = function (fn) {
        util_log(this._name + ".complete(" + _truncateOutput(fn) + ")");
        return run_function_and_return_deferred(fn);
    }

    return ret;
});
jqXHR.toString = jqXHR.toJSON = () => {
    return "jqXHR"
}

// https://api.jquery.com/Jquery/#jQuery1
$ = function (thing) {
    util_log("$(" + thing + ")");
    if (thing == this) {
        thing = this.id;
    } else if (typeof thing === "function") {
        util_log("$(...) was called where ... is a function, running function!");
        let id = thing();
        util_log("$(...) => '" + id + "'");
        return document.getElementById(id);
    }
    return document.getElementById(thing);
};

// https://api.jquery.com/Jquery.ajax/
$.ajax = function (url, settings) {
    util_log("$.ajax(" + JSON.stringify(url) + ")");
    let ret = new jqXHR();
    ret.open(url.type, url.url);
    ret.send();
    return ret;
};

// https://api.jquery.com/jquery.getJSON/
$.getJSON = function (url, data, success) {
    util_log("$.getJSON(" + _truncateOutput(Array.prototype.slice.call(arguments, 0).join(",")) + ")")
    let ret = new jqXHR();
    ret.open("get", url);
    ret.onreadystatechange = success;
    ret.send();
    run_data_function(url, data);
    return ret;
};

// https://api.jquery.com/jQuery.post/
$.post = function (url, data, success, dataType) {
    util_log("$.post(" + _truncateOutput(Array.prototype.slice.call(arguments, 0).join(",")) + ")")
    let ret = new jqXHR();
    ret.open("post", url);
    ret.onreadystatechange = success;
    ret.send(data);
    return ret;
};

// https://stackoverflow.com/questions/4083351/what-does-jquery-fn-mean
$.fn = function () {
    util_log("$.fn(" + _truncateOutput(Array.prototype.slice.call(arguments, 0).join(",")) + ")")
    return this;
}

// https://api.jquery.com/jQuery.get/
$.get = function (url, data, success, dataType) {
    util_log("$.get(" + _truncateOutput(Array.prototype.slice.call(arguments, 0).join(",")) + ")")
    let ret = new jqXHR();
    ret.open("get", url);
    ret.onreadystatechange = success;
    ret.send();
    run_data_function(url, data);
    return ret;
};

// https://api.jquery.com/jQuery.support/
// https://www.w3schools.com/jquery/prop_jquery_support.asp
$.support = {
    "ajax": false,
    "boxModel": false,
    "changeBubbles": false,
    "checkClone": false,
    "checkOn": false,
    "cors": false,
    "cssFloat": false,
    "hrefNormalized": false,
    "htmlSerialize": false,
    "leadingWhitespace": false,
    "noCloneChecked": false,
    "noCloneEvent": false,
    "opacity": false,
    "optDisabled": false,
    "optSelected": false,
    "scriptEval": false,
    "style": false,
    "submitBubbles": false,
    "tbody": false,
}

$.toString = $.toJSON = () => { return "jQuery" }
jQuery = $;

// https://developer.mozilla.org/en-US/docs/Web/API/KeyboardEvent/keyCode
KEYBOARD_EVENT_KEYCODE_MAP = {
    // 13 is the "Enter" button
    "keyup": 13,
    "keypress": undefined,
    "keydown": 13,
}

is_domain_geo = function (url) {
    let domain = new URL(url);
    domain = domain.hostname;
    if (domain.includes("ip") || domain.includes("geo")) {
        util_log("Domain '" + domain + "' is for a GeoIP service.")
        return true;
    }
    return false;
}

const domain_geo_response = {
    "ip": "127.0.0.1",
    "continent_code": "NA",
    "country": "Canada",
    "country_code": "CA",
    "region": "Ottawa",
    "region_code": "OW",
    "city": "Ottawa",
    "org": "organization",
    "postal": "1A1 A1A"
};

// Overriding these methods from third-party libs

// Basic implementation of https://github.com/eligrey/FileSaver.js
saveAs = async function (content, filename) {
    util_log("saveAs(" + content + ", " + filename + ")")

    // Assign the blob contents to the _wscript_saved_files global which will be
    // written to disk after execution
    if (content.constructor.name == "Blob") {
        content = Buffer.from(await content.arrayBuffer());
    }
    _wscript_saved_files[filename] = content;
}


// Google Analytics somehow
ga = function () {
    util_log("ga(" + Array.prototype.slice.call(arguments, 0).join(",") + ")");
}

// top must be assigned at the bottom of this file, otherwise everything becomes a reference to it;
// top is actually the sandbox environment itself. Mind blown.
top = this;
