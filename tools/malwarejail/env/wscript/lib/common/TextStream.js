'use strict';


/**
 * TextStream.js
 * This Object spoofs the TextStream Object
 * Properties and methods taken from Microsoft documentation
 * https://msdn.microsoft.com/en-us/library/312a5kbt(v=vs.84).aspx
 */
class TextStream {
    constructor(filename, contents, unicode, iomode, fullpath) {
        // Default properties
        this._AtEndOfLine    = false;
        this.AtEndOfLine    = this._AtEndOfLine;
        this._AtEndOfStream  = false;
        this.AtEndOfStream  = this._AtEndOfStream;

        this._Column         = 1;
        this.Column         = this._Column;
        this._Line           = 1;
        this.Line           = this._Line;

        // Custom properties
        // Filename can either be a string or a stream (StdIn/StdOut/StdErr)
        this._filename      = filename;
        this._fullpath      = fullpath;

        // Save contents for writing/reading
        this._contents      = contents || '';

        // When not unicode, should throw error when writing unicode
        this._unicode       = unicode === false ? false : true;

        this._id = _object_id++;
        this._name = "TextStream[" + this._id + "]";

        // iomode: ForReading/ForWriting/ForAppending
        if (iomode && [1, 2, 8].indexOf(iomode) === -1) {
            throw new TypeError('Invalid procedure call or argument');
        } else {
            this._iomode = iomode || 1;
            switch (this._iomode) {
                case 1:
                    this._setAtEnds();
                    break;
                case 2:
                    this._contents = '';
                    break;
                case 8:
                    this._setColumnLine();
                    break;
            }
        }
    }

    _parseInt(num) {
        if (typeof num !== 'number' || isNaN(parseInt(num, 10))) throw new TypeError();
        return parseInt(num, 10);
    }

    _setAtEnds() {
        const linesArr = this._contents.split('\n');
        this._AtEndOfLine = linesArr[this._Line - 1].length === this._Column - 1;
        this._AtEndOfStream = linesArr.length === this._Line && this._AtEndOfLine;
    }

    _setColumnLine(column, line) {
        this._Line = line || this._contents.split('\n').length;
        this._Column = column || this._contents.split('\n').pop().length + 1;
    }

    _updateProps(column, line) {
        this._setColumnLine(column, line);
        this._setAtEnds();
    }

    _movePointer(spaces) {
        let i = 0;
        spaces = this._parseInt(spaces);

        while (i < spaces && !this._AtEndOfStream) {
            if (this._AtEndOfLine) {
                this._updateProps(1, this._Line + 1);
            } else {
                this._updateProps(this._Column + 1, this._Line);
            }
            i++;
        }
    }

    // https://msdn.microsoft.com/en-us/library/yb3tbdkw(v=vs.84).aspx
    Close() {
        return null;
    }

    // https://msdn.microsoft.com/en-us/library/dhyx75w2(v=vs.84).aspx
    Read(characters) {
        let linesArr = this._contents.split('\n'),
            startAt = linesArr.splice(this.Line - 1).join('\n').substr(this.Column - 1);

        characters = this._parseInt(characters);

        this._movePointer(characters);

        return startAt.substr(0, characters);
    }

    // https://msdn.microsoft.com/en-us/library/t58aa4dd(v=vs.84).aspx
    ReadAll() {
        return this.Read(this._contents.length);
    }

    // https://msdn.microsoft.com/en-us/library/h7se9d4f(v=vs.84).aspx
    ReadLine() {
        let curLine = this._contents.split('\n')[this.Line - 1],
            line = curLine.substr(this.Column - 1);

        this._updateProps(1, this.Line + 1);

        return line;
    }

    // https://msdn.microsoft.com/en-us/library/08xz3c5a(v=vs.84).aspx
    Skip(characters) {
        this._movePointer(characters);
    }

    // https://msdn.microsoft.com/en-us/library/zbhhkawe(v=vs.84).aspx
    SkipLine(characters) {
        characters = this._parseInt(characters);

        let lines = this._contents.split('\n');

        return lines.slice(characters, lines.length).join('\n');
    }

    // https://msdn.microsoft.com/en-us/library/6ee7s9w2(v=vs.84).aspx
    Write(string) {
        if (!this._unicode && /[^\u0000-\u00ff]/.test(string)) {
            throw new TypeError('Invalid procedure call or argument');
        }

        this._contents += string;
        this._updateProps();
    }

    // https://msdn.microsoft.com/en-us/library/eysctzwa(v=vs.84).aspx
    WriteBlankLines(lines) {
        lines = this._parseInt(lines);

        for (let i = 0; i < lines; i++) {
            this._contents += '\n';
        }
        this._updateProps();
        _wscript_saved_files[this._filename] = this._contents;
    }

    // https://msdn.microsoft.com/en-us/library/t5399c99(v=vs.84).aspx
    WriteLine(string) {
        if (!this._unicode && /[^\u0000-\u00ff]/.test(string)) {
            throw new TypeError('Invalid procedure call or argument');
        }

        this._contents += string ? string + '\n' : '\n';
        this._updateProps();
        _wscript_saved_files[this._filename] = this._contents;
    }

    toString() {
        return this._name;
    }
}


TextStream = new ProxyGenerator(TextStream);
